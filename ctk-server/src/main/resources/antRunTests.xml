<project default="reports">
    <description>This runs tests for the GA4GH CTK</description>
    <!-- Define the classpath which includes the junit.jar and the classes after compiling-->
    <target name="diagnostics" description="diagnostics">
        <diagnostics/>
    </target>

    <target name="make-directories">
        <mkdir dir="${ctk.todir}"/>
        <mkdir dir="${ctk.todir}/lib"/>
        <mkdir dir="${ctk.todir}/report"/>
        <mkdir dir="${ctk.todir}/report/html"/>
    </target>

    <target name="make-test-jar" depends="make-directories">
        <!-- build unified test jar file; eliminating dups and preserve
            order so that newly-compiled classes are not overwritten by the
            precompiled test jar, so you can write/compile one new test
            at a time without re-building the test module -->
        <!-- note that this also leaves a retainable copy of test classes
             with each test run -->
        <jar destfile="${ctk.todir}/lib/packedup-tests.jar"
             duplicate="preserve">
            <zipfileset src="${ctk.testjar}"
                        erroronmissingarchive="false"/>
            <multirootfileset basedirs="${ctk.testclassroots}"
                              type="both"
                              erroronmissingdir="false"/>
        </jar>
    </target>

    <path id="packedup-tests-jar.path" location="${ctk.todir}/lib/packedup-tests.jar" />

    <target name="test-if-classpath-ok">
        <available classname="org.ga4gh.ctk.testrunner.TestExecListener" property="tel.Present"/>
        <echo level="debug">Ant classpath includes org.ga4gh.ctk.TestExecListener? ${tel.Present}</echo>
    </target>

    <target name="tests" if="tel.Present" depends="test-if-classpath-ok, make-directories, make-test-jar">
        <junit printsummary="on" fork="true" filtertrace="on"
               haltonfailure="false" showoutput="false"
               enableTestListenerEvents="false">
            <!-- the 'ctk.runkey' prop lets tests see persisted data from this same run -->
            <!-- see, e.g., the zzCheckCoverage test class -->
            <syspropertyset>
                <propertyref prefix="ctk"/>
                <propertyref prefix="cts"/>
            </syspropertyset>

            <classpath location="${ctk.todir}/lib/packedup-tests.jar"/>

            <batchtest fork="off" skipNonTests="true" todir="${ctk.todir}">
                <zipfileset src="${ctk.todir}/lib/packedup-tests.jar" includes="${ctk.matchstr}"
                            erroronmissingarchive="true"/>
            </batchtest>
            <formatter type="xml"/>
            <formatter type="brief"/>
            <!-- this "formatter" just bridges junit events to the CTK log -->
            <!-- this class isn't on the classpath?? -->
            <formatter classname="org.ga4gh.ctk.testrunner.TestExecListener"/>
        </junit>
    </target>

    <target name="echo-props">
        <!-- Echo's 'level': Control the level at which this message is reported.
        One of "error", "warning", "info", "verbose", "debug" (decreasing order) -->
        <echo level="info">ctk.todir= ${ctk.todir}  ctk.runkey= ${ctk.runkey} basedir= ${basedir} ctkmatchstr= ${ctk.matchstr}</echo>
        <echo level="debug">java.io.tmpdir= ${java.io.tmpdir} </echo>
        <pathconvert pathsep="${line.separator}|  |--"
                     property="echo.test.classes"
                     refid="packedup-tests-jar.path"></pathconvert>
        <echo level="debug">${echo.test.classes}</echo>
    </target>

    <target name="reports" depends="echo-props, make-directories, tests">
        <junitreport todir="${ctk.todir}/report">
            <fileset dir="${ctk.todir}">
                <include name="TEST-*.xml"/>
            </fileset>
            <report format="frames" todir="${ctk.todir}/report/html">
                <param name="TITLE" expression="${ctk.reporttitle}"/>
            </report>
        </junitreport>
    </target>
</project>
